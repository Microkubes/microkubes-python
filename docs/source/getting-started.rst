Getting Started with microkubes-python
======================================

``microkubes-python`` is a library written in Python that contains tools and helpers for integrating
your microservices with Microkubes platform.

It offers:
 
 * Tools to register your serice with Microkubes API Gateway
 * Security library that works with Microkubes own security and user management:
 * Support for JWT based auth
 * Support for OAuth based auth
 * Integration with Flask, so you can secure your Flask API endpoints


Installation and setup
----------------------

To install micrkubes-python run:

    .. code-block:: bash

        pip install "git+https://github.com/Microkubes/microkubes-python#egg=microkubes-python"


If you want to hack around, you can install it with ``pip``:

    .. code-block:: bash
        
        pip install -e "git+https://github.com/Microkubes/microkubes-python#egg=microkubes-python"


or clone this repository directly:

    .. code-block:: bash

        git clone https://github.com/Microkubes/microkubes-python
        cd microkubes-python
        pip setup.py develop
        pip install -r dev-requirements.txt


Use it with Flask
-----------------

If you're developing with `Flask <http://flask.pocoo.org/>`_, then you need to install it additionaly:

    .. code-block:: bash
        
        pip install Flask


Example service in Flask
------------------------

As an example we can write small hello-world-like service in Flask (service.py):

    .. code-block:: python

        import os
        from flask import Flask
        from microkubes.gateway import KongGatewayRegistrator


        app = Flask(__name__)
        registrator = KongGatewayRegistrator(os.environ.get("API_GATEWAY_URL", "http://localhost:8001"))  # Use the Kong registrator for Microkubes


        # Self-registration on the API Gateway must be the first thing we do when running this service.
        # If the registration fails, then the whole service must terminate.
        registrator.register(name="hello-service",                  # the service name.
                            paths=["/hello"],                      # URL pattern that Kong will use to redirect requests to out service
                            host="hello-service.services.consul",  # The hostname of the service.
                            port=5000)                             # Flask default port. When redirecting, Kong will call us on this port.


        @app.route("/hello")
        def hello():
            return "Hello from Flask service on Microkubes"


Gateway registration
====================

The library provides the basic function of registering your own service with the API Gateway.
The tools are provided in package ``microkubes.gateway``.

To register your service on a gateway, you need to use a ``Registrator``. ``microkubes-python`` comes
with support for `Kong Gateway <https://konghq.com/kong-community-edition/>`_.

Example:

    .. code-block:: python

        from microkubes.gateway import KongGatewayRegistrator


        registrator = KongGatewayRegistrator(os.environ.get("API_GATEWAY_URL", "http://localhost:8001"))  # Use the Kong registrator for Microkubes


        # Self-registration on the API Gateway must be the first thing we do when running this service.
        # If the registration fails, then the whole service must terminate.
        registrator.register(name="hello-service",                  # the service name.
                            paths=["/hello"],                      # URL pattern that Kong will use to redirect requests to out service
                            host="hello-service.services.consul",  # The hostname of the service.
                            port=5000)                             # Flask default port. When redirecting, Kong will call us on this port.



Note that the registration of our service to the gateway should be one of the first things that the
service does. On Microkubes microservices do this check first and terminate if anything goes wrong.

Security
========

``microkubes-python`` provides tools for implementing security in your services that works with the
security infrastructure provided by Microkubes.

The security library offers python API for setting up security based on yor needs. It comes with
couple of security providers out-of-the-box:
 
 * JWT provider - can decode and validate JWTs generated by Microkubes ``jwt-issuer`` service
 * OAuth2 provider  -can decode and validate OAuth2 tokens generated by the OAuth2 Authorization Server in Microkubes.

The security is configured as a chain of providers, so you can have more than one type on any endpoint in your
service.

The main entrypoint for this is the ``SecurityChain``. When a new request is made by the client, the ``SecurityChain``
passes it to every provider in the chain. Every provider attempts to authenticate and authorize the request.
If some of the providers is successful, then ``Auth`` object is generated and set i the ``SecurityContext``.

An example of setting up security chain:

    .. code-block:: python

        from microkubes.security import (SecurityChain,
                                        ThreadLocalSecurityContext,
                                        JWTSProvider,
                                        is_authenticated_provider,
                                        KeyStore)

        store = KeyStore(dir_path='./keys')  # we need key store with the RSA keys so we can validate the JWT signature
        context = ThreadLocalSecurityContext()  # Keeps the Auth in thread-local, which is fine for tests, but should be avoided for production

        chain = (SecurityChain(context).
                provider(JWTSecurityProvider(key_store=store)).  # Security chain with JWT auth
                provider(is_authenticated_provider))  # check if the request has been authenticated


        # assuming we receive an HTTP request, the processing of the request can be done like this:
            # try:
            #     chain.execute(context, request, response)
            # except SecurityException serr:
            #     response.status_code = serr.status_code
            #     response.write_json({"code": serr.status_code, "message": str(serr)})


        # then we can access the context to get the Auth object:

        auth = context.get_auth()


Security with Flask services
----------------------------

You can secure your Flask services by using the convinience security builder for Flask.
You need to create new ``Security`` and then use ``Security.secured`` decorator on your endpoints.

By using the example in Flask above, we can secure the action by setting up a full security chain:

    .. code-block:: python

        import os
        from flask import Flask
        from microkubes.gateway import KongGatewayRegistrator
        from microkubes.security import FlaskSecurity


        app = Flask(__name__)
        registrator = KongGatewayRegistrator(os.environ.get("API_GATEWAY_URL", "http://localhost:8001"))  # Use the Kong registrator for Microkubes

        # set up a security chain
        sec = (FlaskSecurity().
                keys_dir("./keys").   # set up a key-store that has at least the public keys from the platform
                jwt().                # Add JWT support
                oauth2().             # Add OAuth2 support
                build())              # Build the security for Flask


        # Self-registration on the API Gateway must be the first thing we do when running this service.
        # If the registration fails, then the whole service must terminate.
        registrator.register(name="hello-service",                  # the service name.
                            paths=["/hello"],                      # URL pattern that Kong will use to redirect requests to out service
                            host="hello-service.services.consul",  # The hostname of the service.
                            port=5000)                             # Flask default port. When redirecting, Kong will call us on this port.


        @app.route("/hello")
        @sec.secured   # this action is now secure
        def hello():
            auth = sec.context.get_auth()  # get the Auth from the security context
            return "Hello %s from Flask service on Microkubes" % auth.username
